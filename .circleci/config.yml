version: 2
jobs:
  build:
    working_directory: ~/workspace
    docker:
      - image: circleci/ruby:2.5.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - bundle-cache-{{ checksum "Gemfile.lock" }}
            - bundle-cache-
      - run: chmod +x ./scripts/install_gsl.sh && ./scripts/install_gsl.sh
      - run: bundle check --path vendor/bundle || bundle install --frozen --path vendor/bundle && bundle package --all
      - save_cache:
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run: git config --global user.name "aloerina01"
      - run: git config --global user.email "4443321+aloerina01@users.noreply.github.com"
      - run: bundle exec rake deploy --trace
  build_js:
    working_directory: ~/workspace
    docker:
      - image: circleci/node:8.9.3
    steps:
      - checkout
      - run: sudo npm install -g npm@latest
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package.json" }}
            - dependency-cache-
      - run: npm run webpack:prod
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
  indexing:
    working_directory: ~/workspace
    docker:
      - image: circleci/ruby:2.5.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - bundle-cache-{{ checksum "Gemfile.lock" }}
            - bundle-cache-
      - run: chmod +x ./scripts/install_gsl.sh && ./scripts/install_gsl.sh
      - run: bundle check --path vendor/bundle || bundle install --frozen --path vendor/bundle && bundle package --all
      - save_cache:
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run: chmod +x ./scripts/indexing.sh && ./scripts/indexing.sh $CI_API_TOKEN $ALGOLIA_ADMIN_API_KEY
workflows:
  version: 2
  build_and_indexing:
    jobs:
      - build
      - indexing:
          requires:
            - build