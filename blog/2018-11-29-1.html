<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み</title>
  <meta name="description" content="Babel6.xと比較するとpolyfillの導入の仕方が大幅に変わっています。以前と似たような名前のプラグインやオプションであっても挙動が違ったりするので、おさらいしてみました。">
  
  <meta name="author" content="aloerina">
  <meta name="copyright" content="&copy; aloerina 2025">
  
  <meta name="google-site-verification" content="FEbLKzXnOoXdy4JCrf6UntpqxWuuK8umvUEhILj8IU8" />
  <link rel="manifest" href="/manifest.json">
  <!-- External libraries -->
  <link rel="stylesheet" as="style" href="/css/prism.css">
  
  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="109x109" href="/assets/icons/favicon 1ldpi.png">
  <link rel="apple-touch-icon" sizes="146x146" href="/assets/icons/favicon 1mdpi.png">
  <link rel="apple-touch-icon" sizes="218x218" href="/assets/icons/favicon 1hdpi.png">
  <link rel="apple-touch-icon" sizes="290x290" href="/assets/icons/favicon 1xhdpi.png">
  <link rel="apple-touch-icon" sizes="435x435" href="/assets/icons/favicon 1xxhdpi.png">
  <link rel="apple-touch-icon" sizes="580x580" href="/assets/icons/favicon 1xxxhdpi.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/favicon 1mdpi.png">
  <meta name="theme-color" content="#546E7A">
  <meta name="apple-mobile-web-app-title" content="mf-code">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="Babel6.xと比較するとpolyfillの導入の仕方が大幅に変わっています。以前と似たような名前のプラグインやオプションであっても挙動が違ったりするので、おさらいしてみました。" />
  <meta property="og:url" content="https://aloerina01.github.io/blog/2018-11-29-1" />
  <meta property="og:site_name" content="Feel and Code" />
  <meta property="og:title" content="Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://aloerina01.github.io/assets/logo_whitebg.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み">
  <meta name="twitter:description" content="Babel6.xと比較するとpolyfillの導入の仕方が大幅に変わっています。以前と似たような名前のプラグインやオプションであっても挙動が違ったりするので、おさらいしてみました。">
  <meta name="twitter:image" content="https://aloerina01.github.io/assets/logo_whitebg.png">
  <meta name="twitter:url" content="https://aloerina01.github.io/blog/2018-11-29-1">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://aloerina01.github.io/blog/2018-11-29-1">
  <link rel="alternate" type="application/rss+xml" title="Feel and Code" href="https://aloerina01.github.io/feed.xml" />

  <meta name="algolia-site-verification"  content="72D549DE860CC566" />

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-39630080-4', 'auto');
    ga('require', 'linkid');
    ga('send', 'pageview', {
      'page': '/blog/2018-11-29-1',
      'title': 'Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み'
    });
  </script>
  

  

  <script src="/dist/prism.js" defer></script>
</head>


<body>

  <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <picture>
        <source src="/assets/logo.webp" type="image/webp"> 
        <img src="/assets/logo_min.png" alt="Feel and Code" loading="lazy">
      </picture>
      
    </a>
    <a class="navigation-menu-button" id="js-mobile-menu-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M2.5 11.5A.5.5 0 0 1 3 11h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 3h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
      </svg>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu">
        <li class="nav-search-box">
          <div class="aa-input-container" id="aa-input-container">
            <input type="search" id="aa-search-input" class="aa-input-search" placeholder="" name="search" autocomplete="off" />
            <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
                <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
            </svg>
          </div>
        </li>
         
        <li class="nav-link">
          <a href="https://note.com/aloerina/m/m699d10700993"target="_blank" rel="noopener noreferrer">Poem</a>
            
        <li class="nav-link">
          <a href="https://suzuri.jp/aloerina"target="_blank" rel="noopener noreferrer">Shop</a>
            
        <li class="nav-link">
          <a href="https://goo.gl/forms/VKcqNYwtEjDUNyN92"target="_blank" rel="noopener noreferrer">Contact</a>
            
        <li class="nav-link">
          <a href="/feed.xml"target="_blank" rel="noopener noreferrer">RSS</a>
           
      </ul>
    </nav>
    <div class="breadcrumbs" style="display:none">
      <ol itemscope itemtype="http://schema.org/BreadcrumbList">
        <li itemscope itemprop="itemListElement" itemtype="http://schema.org/ListItem">
          <a itemprop="item" href="https://aloerina01.github.io/">
            <span itemprop="name">Feel and Code</span>
          </a>
          <meta itemprop="position" content="1" />
        </li>
        
        <li itemscope itemprop="itemListElement" itemtype="http://schema.org/ListItem">
          <a itemprop="item" href="https://aloerina01.github.io/blogs">
            <span itemprop="name">記事</span>
          </a>
          <meta itemprop="position" content="2" />
        </li>
        
        
        <li itemscope itemprop="itemListElement" itemtype="http://schema.org/ListItem">
          <a itemprop="item" href="https://aloerina01.github.io/blog/2018-11-29-1">
            <span itemprop="name">Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み</span>
            </a>
          <meta itemprop="position" content="3" />
        </li>
        
        </ol>
    </div>
  </div>
</header>

  <main class="page-content">
    <div class="post">
      <div class="post-header-container " >
        <div class="scrim ">
          <header class="post-header">
            <h1 class="title">Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み</h1>
            <!-- <p class="info">by <strong></strong></p> -->
          </header>
        </div>
      </div>
      <div class="wrapper">
         <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 
        <section class="post-meta">
          <div class="post-date">2018-11-29</div>
          <div class="post-categories">
            
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="post-categories-icon" viewBox="0 0 16 16">
              <path d="M6 4.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-1 0a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0z"/>
              <path d="M2 1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 1 6.586V2a1 1 0 0 1 1-1zm0 5.586l7 7L13.586 9l-7-7H2v4.586z"/>
            </svg>
             
            <a href="/category/javascript/">JavaScript</a>,    
            <a href="/category/babel/">Babel</a>,    
            <a href="/category/environment/">Environment</a>   
          </div>
        </section>

        <article class="post-content">
          <p>ES2015+で実装するためにBabelのpolyfillを利用する場面は多いと思いますが、Babel6.xまでと7.xではその導入方法が変わっているので注意が必要です。今回はBabel7.xでの<strong>用途別polyfillの設定方法</strong>と、キモとなる<code class="language-plaintext highlighter-rouge">useBuiltIns</code>オプションの挙動についてまとめてみます(執筆時点でのBabelのバージョンは<strong>7.1.0</strong>です)。</p>

<p>なお、6.xまでの設定方法は「<a href="/blog/2018-03-19-1" target="_blank">Babelの設定を見直すための逆引きガイド</a>」にまとめてあります。polyfillのことだけでなく、Babelとは何か、どのように利用するのか、といったことも併せてまとめてありますので良ければご参考にどうぞ。</p>

<div class="revision">
<p class="date">2019/06/21 追記</p>

Babel7.4.0から @babel/polyfill が非推奨となっています。変更点や新しい設定方法は「<a href="/blog/2019-06-21-1">Babel7.4で非推奨になったbabel/polyfillの代替手段と設定方法</a>」の記事をご確認ください。
</div>

<ul id="markdown-toc">
  <li><a href="#用途別polyfillの入れ方" id="markdown-toc-用途別polyfillの入れ方">用途別polyfillの入れ方</a>    <ul>
      <li><a href="#1-必要なpolyfillだけを入れる方法" id="markdown-toc-1-必要なpolyfillだけを入れる方法">1. 必要なpolyfillだけを入れる方法</a></li>
      <li><a href="#2-全てのpolyfillを入れる方法" id="markdown-toc-2-全てのpolyfillを入れる方法">2. 全てのpolyfillを入れる方法</a></li>
      <li><a href="#3-グローバル汚染せずにpolyfillを適用する方法" id="markdown-toc-3-グローバル汚染せずにpolyfillを適用する方法">3. グローバル汚染せずにpolyfillを適用する方法</a></li>
    </ul>
  </li>
  <li><a href="#usebuiltinsのコードリーディング" id="markdown-toc-usebuiltinsのコードリーディング">useBuiltInsのコードリーディング</a>    <ul>
      <li><a href="#babel-preset-envsrcindexjsl285" id="markdown-toc-babel-preset-envsrcindexjsl285">babel-preset-env/src/index.js#L285</a></li>
      <li><a href="#babel-preset-envsrcuse-built-ins-entry-pluginjsl31" id="markdown-toc-babel-preset-envsrcuse-built-ins-entry-pluginjsl31">babel-preset-env/src/use-built-ins-entry-plugin.js#L31</a></li>
      <li><a href="#babel-preset-envsrcuse-built-ins-pluginjsl68" id="markdown-toc-babel-preset-envsrcuse-built-ins-pluginjsl68">babel-preset-env/src/use-built-ins-plugin.js#L68</a></li>
      <li><a href="#babelhelper-module-imports" id="markdown-toc-babelhelper-module-imports">@babel/helper-module-imports</a></li>
    </ul>
  </li>
  <li><a href="#あとがき" id="markdown-toc-あとがき">あとがき</a></li>
</ul>

<h3 id="用途別polyfillの入れ方">用途別polyfillの入れ方</h3>

<p>polyfillの入れ方には大きく3種類あります。</p>

<table>
  <thead>
    <tr>
      <th>用途</th>
      <th>方法</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>必要なpolyfillだけ入れる</td>
      <td><code class="language-plaintext highlighter-rouge">useBuiltIns</code>オプション <strong>usage</strong> を使う</td>
    </tr>
    <tr>
      <td>全てのpolyfillを入れる</td>
      <td><a href="https://babeljs.io/docs/en/babel-polyfill" target="_blank">@babel/polyfill</a>をimport/requireする</td>
    </tr>
    <tr>
      <td>グローバル汚染せずにpolyfillを適用する</td>
      <td><a href="https://babeljs.io/docs/en/babel-runtime" target="_blank">@babel/runtime</a>と<br /><a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime" target="_blank">@babel/plugin-transform-runtime</a>を使う</td>
    </tr>
  </tbody>
</table>

<p></p>

<p>大幅に変更されたのが<code class="language-plaintext highlighter-rouge">useBuiltIns</code>オプションの挙動です。6.xではまずbabel-polyfillを入れた上で「それをどのようにcore-jsに置き換えるか」をuseBuiltInsオプションで指定する形でした。
対して7.xでは<code class="language-plaintext highlighter-rouge">useBuiltIns</code>オプションに応じて@babel/polyfillを入れたり入れなかったりします。</p>

<p>ではそれぞれの方法の詳細を見ていきます。</p>

<h4 id="1-必要なpolyfillだけを入れる方法">1. 必要なpolyfillだけを入れる方法</h4>

<p><strong><a href="https://babeljs.io/docs/en/babel-preset-env" target="_blank">@babel/preset-env</a>の<code class="language-plaintext highlighter-rouge">useBuiltIns</code>オプションを<code class="language-plaintext highlighter-rouge">usage</code>とする</strong>と、@babel/polyfillをソース内でimportせずとも必要なpolyfillだけを自動で選別して入れてくれます。ただし、<strong>@babel/polyfillをnpm installしておく</strong>必要はあります。</p>

<p><strong>@babel/polyfill, @babel/preset-envをインストールする</strong></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-D</span> @babel/preset-env
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-S</span> @babel/polyfill
</code></pre></div></div>

<p></p>

<p><strong>.babelrcを記述する</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"presets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">[</span><span class="w">
      </span><span class="s2">"@babel/preset-env"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"useBuiltIns"</span><span class="p">:</span><span class="w"> </span><span class="s2">"usage"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p></p>

<p>この方法はメリットが大きいですが、公式ドキュメントに<strong>experimental</strong>と記されている点を忘れてはいけません。<br />
試しにpolyfillが必要な実装例を<a href="https://github.com/aloerina01/til/tree/master/daily/20181128" target="_blank">いくつか試してみた</a>ところ、polyfillが入らないケースがありました。分かりやすかった例をピックアップしてみます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">let</span> <span class="nx">letObj</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">const</span> <span class="nx">constObj</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">obj</span><span class="p">[</span><span class="dl">'</span><span class="s1">includes</span><span class="dl">'</span><span class="p">];</span>      <span class="c1">// array.includes と string.includes のpolyfillが入る</span>
<span class="nx">letObj</span><span class="p">[</span><span class="dl">'</span><span class="s1">includes</span><span class="dl">'</span><span class="p">];</span>   <span class="c1">// polyfillが入らない</span>
<span class="nx">constObj</span><span class="p">[</span><span class="dl">'</span><span class="s1">includes</span><span class="dl">'</span><span class="p">];</span> <span class="c1">// polyfillが入らない</span>

<span class="c1">// --------</span>

<span class="kd">const</span> <span class="nx">getName</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">includes</span><span class="dl">'</span><span class="p">;</span>
<span class="dl">'</span><span class="s1">str</span><span class="dl">'</span><span class="p">[</span><span class="nx">getName</span><span class="p">()];</span>     <span class="c1">// string.includes のpolyfillが入らない</span>
</code></pre></div></div>

<p>静的解析してimportするpolyfillを特定している感じでしょうか。<br />
スコープが不明確だと中身を特定しきれないので、使われる可能性のあるpolyfillを入れていますね。また、関数は実行しないと結果を判断できないようです。この感じだと、個人的にはproduction利用はまだちょっと怖い…と思ってしまいます。</p>

<p>ちなみに「importされているか怪しいpolyfillを個別に手動でimportする」案も考えたのですが、手動で入れたものとの重複判定はしてくれないようでしたので、この案もダメそうですね😳</p>

<h4 id="2-全てのpolyfillを入れる方法">2. 全てのpolyfillを入れる方法</h4>

<p>Babel6.xまでと同じように<strong><a href="https://babeljs.io/docs/en/babel-polyfill" target="_blank">@babel/polyfill</a>をimport/requireする</strong>方法です。合わせて<code class="language-plaintext highlighter-rouge">useBuiltIns</code>オプションに<code class="language-plaintext highlighter-rouge">entry</code>か<code class="language-plaintext highlighter-rouge">false(default)</code>を指定することができます。</p>

<p><strong>@babel/polyfill, @babel/preset-envをインストールする</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-D</span> @babel/preset-env
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-S</span> @babel/polyfill
</code></pre></div></div>

<p></p>

<p><strong>エントリーポイントでpolyfillを読み込む</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// index.js</span>

<span class="k">import</span> <span class="dl">'</span><span class="s1">@babel/polyfill</span><span class="dl">'</span><span class="p">;</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>  <span class="c1">// polyfillが必要な実装</span>
</code></pre></div></div>

<p></p>

<p><strong>.babelrcを記述する</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"presets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">[</span><span class="w">
      </span><span class="s2">"@babel/preset-env"</span><span class="p">,</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"useBuiltIns"</span><span class="p">:</span><span class="w"> </span><span class="s2">"entry"</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">任意</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">useBuiltIns</code>に<code class="language-plaintext highlighter-rouge">entry</code>を指定すると、@babel/polyfillのimportを<strong>生のcore-jsのimportに置換してくれます</strong>。また、今まで通り同じpolyfillを複数回importするのはNGなのでその点もお忘れなく。</p>

<h4 id="3-グローバル汚染せずにpolyfillを適用する方法">3. グローバル汚染せずにpolyfillを適用する方法</h4>

<p>Babel6.xまででは<code class="language-plaintext highlighter-rouge">babel-plugin-transform-runtime</code>を使っていましたが、7.xからは2つのmoduleを使います。</p>

<ul>
  <li><a href="https://babeljs.io/docs/en/babel-runtime" target="_blank">@babel/runtime</a> … ソースにバンドルされるpolyfill本体</li>
  <li><a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime" target="_blank">@babel/plugin-transform-runtime</a> … polyfillが必要な箇所を@babel/runtimeに置き換えてくれるもの</li>
</ul>

<p><strong>@babel/runtime, @babel/plugin-transform-runtimeをインストールする</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-S</span> @babel/runtime
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-D</span> @babel/plugin-transform-runtime
</code></pre></div></div>

<p></p>

<p><strong>.babelrcを記述する</strong></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">plugins</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">@babel/plugin-transform-runtime</span><span class="dl">"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p></p>

<p>利用の際は、Babel6.xまでと同様に<strong>インスタンスメソッドは使えない</strong>ということに注意する必要があります。</p>

<h3 id="usebuiltinsのコードリーディング">useBuiltInsのコードリーディング</h3>

<p>ここからは余談です。<br />
useBuiltInsオプションがどのように実装されているか気になったので、軽くコードリーディングしてみました。そのときのメモをまとめておきます。</p>

<h5 id="babel-preset-envsrcindexjsl285"><a href="https://github.com/babel/babel/blob/59e9c6322baf6cbd1952c40ce5dd0b2ea7802712/packages/babel-preset-env/src/index.js#L285" target="_blank">babel-preset-env/src/index.js#L285</a></h5>

<p><code class="language-plaintext highlighter-rouge">useBuiltIns</code>の値に応じて利用するプラグインを分岐しています。</p>

<ul>
  <li>entry設定時 <a href="https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-entry-plugin.js" target="_blank">babel/use-built-ins-entry-plugin.js</a></li>
  <li>usage設定時 <a href="https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-plugin.js" target="_blank">babel/use-built-ins-plugin.js</a></li>
</ul>

<p>これらのプラグインは、どちらも以下のようなPluginオブジェクトを返す関数を実装しています。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">default</span> <span class="kd">function</span><span class="p">({</span> <span class="na">types</span><span class="p">:</span> <span class="nx">t</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">types</span><span class="p">:</span> <span class="nb">Object</span> <span class="p">}):</span> <span class="nx">Plugin</span><span class="p">;</span>

<span class="nx">type</span> <span class="nx">Plugin</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">visitor</span><span class="p">:</span> <span class="nb">Object</span><span class="p">,</span>  <span class="c1">// polyfill の import を解決するための処理群</span>
  <span class="na">pre</span><span class="p">:</span> <span class="nb">Function</span><span class="p">,</span>   <span class="c1">// メイン処理前に実行すること</span>
  <span class="na">name</span><span class="p">:</span> <span class="nx">string</span>     <span class="c1">// pluginの識別子のようなもの</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Plugin.visitorが大きく差が出る部分ですね。</p>

<h5 id="babel-preset-envsrcuse-built-ins-entry-pluginjsl31"><a href="https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-entry-plugin.js#L31" target="_blank">babel-preset-env/src/use-built-ins-entry-plugin.js#L31</a></h5>

<p>Plugin.visitorに渡される<code class="language-plaintext highlighter-rouge">isPolyfillImport</code>オブジェクトを見ると、<code class="language-plaintext highlighter-rouge">ImportDeclaration</code>関数に「@babel/polyfillがimportされてるならフラグをたてて、それを必要なmoduleのimportにreplaceしていく」といった実装があります。</p>

<h5 id="babel-preset-envsrcuse-built-ins-pluginjsl68"><a href="https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-plugin.js#L68" target="_blank">babel-preset-env/src/use-built-ins-plugin.js#L68</a></h5>

<p>Plugin.visitorに渡される<code class="language-plaintext highlighter-rouge">addAndRemovePolyfillImports</code>オブジェクトを見ると、「@babel/polyfillがimportされていないことを確認する<code class="language-plaintext highlighter-rouge">ImportDeclaration</code>関数」と、「個々のpolyfillのimportするための関数」が存在します。後者については、ソースを解析して実装方法に応じて呼び出す関数を使い分けている感じですかね。</p>

<p>個々のpolyfillをimportするための関数は、最終的にutilsの<code class="language-plaintext highlighter-rouge">createImport</code>関数を呼び出し、その中で更に<a href="https://github.com/babel/babel/blob/master/packages/babel-helper-module-imports/src/index.js" target="_blank">@babel/helper-module-imports</a>に処理を委譲しています。この@babel/helper-module-importsがpolyfillを個別にimportする本体ですね。</p>

<h5 id="babelhelper-module-imports"><a href="https://github.com/babel/babel/tree/master/packages/babel-helper-module-imports" target="_blank">@babel/helper-module-imports</a></h5>

<p>src以下には3つのファイルがあります。</p>

<p><strong>index.js</strong><br />
外部から呼び出されるpublicな関数。処理の実態は以下の2つに委譲。</p>

<p><strong>import-injector.js</strong><br />
polyfillの注入を担うclass。1つのpolyfillにつき1インスタンスを生成し、polyfillの性質(クラスメソッドなのか、インスタンスメソッドなのか、等)に応じた方法で注入する処理を呼び出す。</p>

<p><strong>import-bulder.js</strong><br />
上述の「注入する処理」の本体。慎ましいBuilderパターンで実装されている。</p>

<p>以上、ざっくりとしたコードリーディングでした。@babel/coreのほうまではちゃんと読んでないので誤りがあるかもしれませんが、なんとなく<code class="language-plaintext highlighter-rouge">useBuiltIns</code>による挙動の違いを想定できたので良しとします。</p>

<h3 id="あとがき">あとがき</h3>

<p>今回の記事はBabel7.1.0のドキュメントとソースを参考にしています。今後また仕様が変わることもあると思うので、記事内に古い情報や誤りを見つけた際は<a href="https://twitter.com/aloerina_" target="_blank">@aloerina_</a>までご連絡いただければと思います。</p>

        </article>

          

        <section class="share">
  <div class="share-inner">
    <div class="share-description">
      <span>感想をシェアする</span>
    </div>
    <div class="share-panel">
      <a
        href="http://b.hatena.ne.jp/entry/"
        class="hatena-bookmark-button share-button share-button-hatebu"
        data-hatena-bookmark-layout="touch"
        data-hatena-bookmark-width="38"
        data-hatena-bookmark-height="38"
        title="このエントリーをはてなブックマークに追加"
        style="
          border-radius: 50%;
          width: 38px;
          height: 38px;
          box-shadow: 1px 1px 10px #bbb;
          background-color: #00a4de;
          transition: all 0.4s ease;
        "
      >
        <img
          src="https://b.st-hatena.com/images/entry-button/button-only@2x.png"
          alt="このエントリーをはてなブックマークに追加"
          width="16"
          height="16"
        />
      </a>
      <script
        type="text/javascript"
        src="https://b.st-hatena.com/js/bookmark_button.js"
        charset="utf-8"
        defer
      ></script>
        
      <a
        class="share-button share-button-x"
        href="//twitter.com/share?text=Babel7.x%E6%99%82%E4%BB%A3%E3%81%AEpolyfill%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95%E3%81%A8useBuiltIns%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF&url=https://aloerina01.github.io/blog/2018-11-29-1&via=aloerina_&hashtags=JavaScript,Babel,Environment,mfcode"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"
      >
        <svg
          version="1.1"
          id="svg5"
          xmlns:svg="http://www.w3.org/2000/svg"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          x="0px"
          y="0px"
          viewBox="0 0 1668.56 1221.19"
          style="enable-background: new 0 0 1668.56 1221.19"
          xml:space="preserve"
          width="38"
          height="38"
        >
          <style type="text/css">
            .st0 {
              stroke: #ffffff;
              stroke-miterlimit: 10;
            }
            .st1 {
              fill: #ffffff;
            }
          </style>
          <g>
            <g id="layer1" transform="translate(52.390088,-25.058597)">
              <path
                id="path1009"
                class="st1"
                d="M485.39,356.79l230.07,307.62L483.94,914.52h52.11l202.7-218.98l163.77,218.98h177.32
                L836.82,589.6l215.5-232.81h-52.11L813.54,558.46L662.71,356.79H485.39z M562.02,395.17h81.46l359.72,480.97h-81.46L562.02,395.17
                z"
              />
            </g>
          </g>
        </svg>
      </a>
                
      <a
        class="share-button share-button-facebook"
        href="//www.facebook.com/sharer.php?t=Babel7.x%E6%99%82%E4%BB%A3%E3%81%AEpolyfill%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95%E3%81%A8useBuiltIns%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF&u=https://aloerina01.github.io/blog/2018-11-29-1"
        onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M9.19795 21.5H13.198V13.4901H16.8021L17.198 9.50977H13.198V7.5C13.198 6.94772 13.6457 6.5 14.198 6.5H17.198V2.5H14.198C11.4365 2.5 9.19795 4.73858 9.19795 7.5V9.50977H7.19795L6.80206 13.4901H9.19795V21.5Z"
            fill="currentColor"
          />
        </svg>
      </a>
                                                                                                                                        
      <a
        class="share-button share-button-pocket"
        href="//getpocket.com/edit?url=https://aloerina01.github.io/blog/2018-11-29-1"
        target="_blank"
      >
        <img src="/assets/thirdparty/pocket.png" alt="Save to Pocket" loading="lazy" />
      </a>
                
      <a
        class="share-button share-button-line"
        target="_blank"
        href="//line.me/R/msg/text/?Babel7.x%E6%99%82%E4%BB%A3%E3%81%AEpolyfill%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95%E3%81%A8useBuiltIns%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%0D%0Ahttps%3A%2F%2Faloerina01.github.io%2Fblog%2F2018-11-29-1"
      >
        <img src="/assets/thirdparty/linebutton.png" alt="LINEで送る" loading="lazy" />
      </a>
       
    </div>
  </div>
</section>


        <section class="post-donation">
  <div class="post-donation-panel">
    <span class="post-donation-description">
      執筆時のコーヒーで応援する
    </span>
    <a class="donation-button" href="https://www.amazon.jp/hz/wishlist/ls/2B61O6E56WG47?ref_=wl_share" target="_blank" rel="noopener noreferrer" onClick="ga('send', 'event', 'click_buymeacoffee', 'post')">
      <p class="button-body">
        <img class="icon" alt="buymeacoffee" src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg"></img>
        <span class="label">欲しいものリストから贈る</span>
      </p>
    </a>
  </div>
</section>

         

      </div>
    </div>

  </main>

  
    <section class="sub-contents related-posts">
  <div class="sub-contents-wrapper">
    <div class="sub-contents-title">
      <h3>あわせて読みたい</h3>
      <hr>
    </div>
    <div class="sub-contents-main">
      
      <li><a href="/blog/2025-08-04-1">議論を“立て直す”ときに使える、力点と作用点を効かせるファシリテーション</a></li>
      
      <li><a href="/blog/2025-05-12-1">1on1再入門 - “傾聴する”から”好奇心を持って問いを設計する”へ</a></li>
      
      <li><a href="/blog/2025-05-07-1">“我々はなぜここにいるのか”の問いを手放した理由 - 心の発達理論から学ぶEMの問いの設計</a></li>
      
      <li><a href="/blog/2025-03-31-1">「若手が育っていない」「優秀な人に負担が偏っている」と感じたときに立ち返ること</a></li>
      
      <li><a href="/blog/2025-02-12-1">計画的にロールモデルを活用する</a></li>
      
    </div>
  </div>
</section>

  

  <section class="sub-contents profile-bar">
  <div class="sub-contents-wrapper profile-bar-wrapper">
    <div class="sub-contents-title">
      <h3>Profile</h3>
      <hr>
    </div>
    <div class="sub-contents-main profile-bar-main">
      <div class="profile-image">
        <img src="/assets/profile_v4.jpg" alt="" loading="lazy">
      </div>
      <div class="profile-content">
        <div class="profile-content-name"><p>aloerina</p></div>
        <div class="profile-content-description">
          <p>
            <span>Webフロントエンド開発、エンジニアリングマネジメント、スクラムマスターなどをしています。趣味でドット絵グッズをつくっています。</span>
          </p>
        </div>
        <div class="profile-content-sns">
          <a target="_blank" href="https://twitter.com/aloerina_" rel="noopener noreferrer" class="sns-icon sns-icon-x">
            <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 462.799"><path fill="#fff" fill-rule="nonzero" d="M403.229 0h78.506L310.219 196.04 512 462.799H354.002L230.261 301.007 88.669 462.799h-78.56l183.455-209.683L0 0h161.999l111.856 147.88L403.229 0zm-27.556 415.805h43.505L138.363 44.527h-46.68l283.99 371.278z"/></svg>
          </a>
          <a target="_blank" href="https://www.instagram.com/pixtrium/" rel="noopener noreferrer" class="sns-icon">
            <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 512"><path fill="#fff" fill-rule="nonzero" d="M170.663 256.157c-.083-47.121 38.055-85.4 85.167-85.483 47.121-.092 85.407 38.03 85.499 85.16.091 47.129-38.047 85.4-85.176 85.492-47.112.09-85.399-38.039-85.49-85.169zm-46.108.091c.141 72.602 59.106 131.327 131.69 131.186 72.592-.141 131.35-59.09 131.209-131.692-.141-72.577-59.114-131.335-131.715-131.194-72.585.141-131.325 59.115-131.184 131.7zm237.104-137.091c.033 16.953 13.817 30.681 30.772 30.648 16.961-.033 30.689-13.811 30.664-30.764-.033-16.954-13.818-30.69-30.78-30.657-16.962.033-30.689 13.818-30.656 30.773zm-208.696 345.4c-24.958-1.087-38.511-5.234-47.543-8.709-11.961-4.629-20.496-10.178-29.479-19.094-8.966-8.95-14.532-17.46-19.202-29.397-3.508-9.032-7.73-22.569-8.9-47.527-1.269-26.982-1.559-35.077-1.683-103.432-.133-68.339.116-76.434 1.294-103.441 1.069-24.942 5.242-38.512 8.709-47.536 4.628-11.977 10.161-20.496 19.094-29.479 8.949-8.982 17.459-14.532 29.403-19.202 9.025-3.525 22.561-7.714 47.511-8.9 26.998-1.277 35.085-1.551 103.423-1.684 68.353-.132 76.448.108 103.456 1.295 24.94 1.086 38.51 5.217 47.527 8.709 11.968 4.628 20.503 10.144 29.478 19.094 8.974 8.95 14.54 17.443 19.21 29.412 3.524 9 7.714 22.553 8.892 47.494 1.285 26.999 1.576 35.095 1.7 103.433.132 68.355-.117 76.451-1.302 103.441-1.087 24.958-5.226 38.52-8.709 47.561-4.629 11.952-10.161 20.487-19.103 29.471-8.941 8.949-17.451 14.531-29.403 19.201-9.009 3.517-22.561 7.714-47.494 8.9-26.998 1.269-35.086 1.559-103.448 1.684-68.338.132-76.424-.125-103.431-1.294zM149.977 1.773c-27.239 1.285-45.843 5.648-62.101 12.018-16.829 6.561-31.095 15.354-45.286 29.604C28.381 57.653 19.655 71.944 13.144 88.79c-6.303 16.299-10.575 34.912-11.778 62.168C.172 178.264-.102 186.973.031 256.489c.133 69.508.439 78.234 1.741 105.547 1.302 27.231 5.649 45.828 12.019 62.093 6.569 16.83 15.353 31.088 29.611 45.288 14.25 14.201 28.55 22.918 45.404 29.438 16.282 6.295 34.902 10.583 62.15 11.778 27.305 1.203 36.022 1.468 105.521 1.335 69.532-.132 78.25-.439 105.555-1.733 27.239-1.303 45.826-5.665 62.1-12.019 16.829-6.586 31.095-15.353 45.288-29.611 14.191-14.251 22.917-28.55 29.428-45.405 6.304-16.282 10.592-34.903 11.777-62.134 1.195-27.322 1.478-36.048 1.344-105.556-.133-69.516-.447-78.225-1.741-105.523-1.294-27.255-5.657-45.844-12.019-62.118-6.577-16.829-15.352-31.079-29.602-45.287-14.25-14.192-28.55-22.935-45.404-29.429-16.29-6.305-34.903-10.601-62.15-11.779C333.747.164 325.03-.102 255.506.031c-69.507.133-78.224.431-105.529 1.742z"/></svg>
          </a>
          
        </div>
      </div>
    </div>
  </div>
</section>
  
  <section class="sub-contents tag-list">
  <div class="sub-contents-wrapper tag-list-wrapper">
    <div class="sub-contents-title">
      <h3>Tags</h3>
      <hr>
    </div>
    <div class="sub-contents-main">
      
        
        
        <a href="/category/jekyll/">Jekyll</a>
      
        
        
        <a href="/category/javascript/">JavaScript</a>
      
        
        
        <a href="/category/webpack/">Webpack</a>
      
        
        
        <a href="/category/environment/">Environment</a>
      
        
        
        <a href="/category/seo/">SEO</a>
      
        
        
        <a href="/category/qualityassurance/">QualityAssurance</a>
      
        
        
        <a href="/category/css/">CSS</a>
      
        
        
        <a href="/category/yarn/">Yarn</a>
      
        
        
        <a href="/category/react/">React</a>
      
        
        
        <a href="/category/vue/">Vue</a>
      
        
        
        <a href="/category/hyperapp/">Hyperapp</a>
      
        
        
        <a href="/category/vuex/">Vuex</a>
      
        
        
        <a href="/category/babel/">Babel</a>
      
        
        
        <a href="/category/exp/">EXP</a>
      
        
        
        <a href="/category/shell/">shell</a>
      
        
        
        <a href="/category/dart/">Dart</a>
      
        
        
        <a href="/category/flutter/">Flutter</a>
      
        
        
        <a href="/category/flux/">Flux</a>
      
        
        
        <a href="/category/algolia/">algolia</a>
      
        
        
        <a href="/category/mobprogramming/">MobProgramming</a>
      
        
        
        <a href="/category/management/">Management</a>
      
        
        
        <a href="/category/coaching/">Coaching</a>
      
        
        
        <a href="/category/grareco/">GraReco</a>
      
        
        
        <a href="/category/githubactions/">GitHubActions</a>
      
        
        
        <a href="/category/retrospective/">Retrospective</a>
      
        
        
        <a href="/category/facilitation/">Facilitation</a>
      
        
        
        <a href="/category/scrum/">Scrum</a>
      
        
        
        <a href="/category/psychologicalsafety/">PsychologicalSafety</a>
      
        
        
        <a href="/category/typescript/">TypeScript</a>
      
        
        
        <a href="/category/chromeextension/">ChromeExtension</a>
      
        
        
        <a href="/category/esbuild/">esbuild</a>
      
        
        
        <a href="/category/agile/">Agile</a>
      
    </div>
  </div>
</section>

  <section class="sub-contents donation">
  <div class="sub-contents-wrapper donation-wrapper">
    <h3>BUY ME A COFFEE</h3>
    <p class="donation-description">記事執筆時のコーヒーをごちそういただけると励みになります。</p>
    <div class="donation-button-area">
        <a class="donation-button" href="https://www.amazon.jp/hz/wishlist/ls/2B61O6E56WG47?ref_=wl_share" target="_blank" rel="noopener noreferrer" onClick="ga('send', 'event', 'click_buymeacoffee', 'site')">
          <p class="button-body">
            <img class="icon" alt="buymeacoffee" src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" loading="lazy"></img>
            <span class="label">欲しいものリストから贈る</span>
          </p>
        </a>
    </div>
  <div>
</section>
  
  <footer class="sub-contents site-footer-v2">
  <div class="sub-contents-wrapper site-footer-v2-wrapper">
    <div class="footer-v2-main">
      <div class="site-values">
        <a href="/" class="site-values-title">Feel and Code (formerly: mille-feuille code)</a>
        <p class="site-values-anotation">
          <span>since 2016 aloerina All Rights Reserved.</span><br>
          <span>サイト内のリンクにはアフェリエイトリンクが含まれる場合があります。</span>
        </p>
      </div>
      <div class="site-designs">
        <p>Published on <a target="_blank" href="https://github.com/aloerina01/aloerina01.github.io" rel="noopener noreferrer">GitHub</a></p>
      </div>
    </div>
  </div>
</footer>

  <script>
  window.addEventListener('DOMContentLoaded', function() {
    // Header
    var CLASS_MENU_SHOW = 'show';
    var navigationMenu = document.getElementById('js-navigation-menu');
    var menuIcon = document.getElementById('js-mobile-menu-icon');
    menuIcon.addEventListener('click', function(e) {
      e.preventDefault();
      navigationMenu.classList.toggle(CLASS_MENU_SHOW);
    });
  });
  </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/3.35.1/algoliasearch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.1/autocomplete.min.js"></script>
<script src="/dist/algolia.js" async></script>

</body>

</html>