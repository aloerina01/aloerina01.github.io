---
title: Babel7.x時代のpolyfillの設定方法とuseBuiltInsの仕組み
outline: 
categories: ['JavaScript', 'Babel', 'Environment']
---


ES2015+で実装するためにBabelのpolyfillを利用する場面は多いと思いますが、Babel6.xまでと7.xではその導入方法が変わっているので注意が必要です(執筆時点でのBabelのバージョンは**7.1.0**です)。今回はBabel7.xでの用途別polyfillの設定の仕方と、キモとなる`useBuiltIns`オプションの挙動についてまとめてみます。

と、その前に6.xまでの入れ方をおさらいしておきます。

1. ソース内で[babel-polyfill](https://babeljs.io/docs/en/6.26.3/babel-polyfill){:target="_blank"}をimport/requireする(同時に`useBuiltIns:true`オプションを利用可)
2. webpackなどで[babel-polyfill](https://babeljs.io/docs/en/6.26.3/babel-polyfill){:target="_blank"}と結合してbundleする
3. [babel-plugin-transform-runtime](https://babeljs.io/docs/en/6.26.3/babel-plugin-transform-runtime){:target="_blank"}を使う

これらの手法にはメリット・デメリットがあり、場面に応じて使い分けが必要でした。詳細は[Babelの設定を見直すための逆引きガイド]({% post_url /blog/2018-03-19-1 %}){:target="_blank"}にまとめてあります(polyfillのことだけでなく、Babelとは何か、どのように利用するのか、といったことも併せてまとめてありますので良ければご参考にどうぞ)。

では、以下本編です。

* TOC
{:toc}

### 用途別polyfillの入れ方


polyfillの入れ方には大きく3種類あります。

| 用途                                   | 方法                                                               |
|----------------------------------------|--------------------------------------------------------------------|
| 必要なpolyfillだけ入れる               | `useBuiltIns`オプション **usage** を使う                           |
| 全てのpolyfillを入れる                 | [@babel/polyfill](https://babeljs.io/docs/en/babel-polyfill){:target="_blank"}をimport/requireする                                            |
| グローバル汚染せずにpolyfillを適用する | [@babel/runtime](https://babeljs.io/docs/en/babel-runtime){:target="_blank"}または<br>[@babel/plugin-transform-runtime](https://babeljs.io/docs/en/babel-plugin-transform-runtime){:target="_blank"}を使う |

<p></p>

大幅に変更されたのが`useBuiltIns`オプションの挙動です。6.xではまずbabel-polyfillを入れた上で「それをどのようにcore-jsに置き換えるか」をuseBuiltInsオプションで指定する形でした。
対して7.xでは`useBuiltIns`オプションに応じて@babel/polyfillを入れたり入れなかったりします。

ではそれぞれの方法の詳細を見ていきます。


#### 1. 必要なpolyfillだけを入れる方法

[@babel/preset-env](https://babeljs.io/docs/en/babel-preset-env){:target="_blank"}の`useBuiltIns`オプションを`usage`とすると、@babel/polyfillをimportせずとも必要なpolyfillだけを自動で選別して入れてくれます。


**@babel/preset-envをインストールする**
```shell
$ npm install -D @babel/preset-env
```

<p></p>

**.babelrcを記述する**
```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage"
      }
    ]
  ]
}
```

<p></p>

この方法はメリットが大きいですが、公式ドキュメントに**experimental**と記されている点が要注意です。  
簡単にpolyfillが必要な実装例を[何パターンか試してみた](https://github.com/aloerina01/til/tree/master/daily/20181128){:target="_blank"}ところ、一応動的なコードであっても正しくpolyfillが読み込まれていました(すごい)。が、production利用は自己責任でやったほうが良さそうですね。


#### 2. 全てのpolyfillを入れる方法

Babel6.xまでと同じように[@babel/polyfill](https://babeljs.io/docs/en/babel-polyfill){:target="_blank"}をimport/requireする方法です。合わせて`useBuiltIns`オプションに`entry`か`false(default)`を指定することができます。

**@babel/polyfill, @babel/preset-envをインストールする**

```shell
npm install -D @babel/preset-env
npm install -S @babel/polyfill
```

<p></p>

**エントリーポイントでpolyfillを読み込む**

```js
// index.js
import '@babel/polyfill';

Promise.resolve();  // polyfillが必要な実装
```

<p></p>

**.babelrcを記述する**
```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "entry"  // 任意
      }
    ]
  ]
}
```

`useBuiltIns`に`entry`を指定すると、@babel/polyfillのimportを生のcore-jsのimportに置換してくれます。


#### 3. グローバル汚染せずにpolyfillを適用する方法



### useBuiltInsの仕組み





