---
title: Babel7.xæ™‚ä»£ã®polyfillã®è¨­å®šæ–¹æ³•ã¨useBuiltInsã®ä»•çµ„ã¿
outline: 
categories: ['JavaScript', 'Babel', 'Environment']
---


ES2015+ã§å®Ÿè£…ã™ã‚‹ãŸã‚ã«Babelã®polyfillã‚’åˆ©ç”¨ã™ã‚‹å ´é¢ã¯å¤šã„ã¨æ€ã„ã¾ã™ãŒã€Babel6.xã¾ã§ã¨7.xã§ã¯ãã®å°å…¥æ–¹æ³•ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™)ã€‚ä»Šå›ã¯Babel7.xã§ã®ç”¨é€”åˆ¥polyfillã®è¨­å®šã®ä»•æ–¹ã¨ã€ã‚­ãƒ¢ã¨ãªã‚‹`useBuiltIns`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ™å‹•ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã™(åŸ·ç­†æ™‚ç‚¹ã§ã®Babelã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯**7.1.0**ã§ã™)ã€‚

ãªãŠã€6.xã¾ã§ã®è¨­å®šæ–¹æ³•ã¯ã€Œ[Babelã®è¨­å®šã‚’è¦‹ç›´ã™ãŸã‚ã®é€†å¼•ãã‚¬ã‚¤ãƒ‰]({% post_url /blog/2018-03-19-1 %}){:target="_blank"}ã€ã«ã¾ã¨ã‚ã¦ã‚ã‚Šã¾ã™(polyfillã®ã“ã¨ã ã‘ã§ãªãã€Babelã¨ã¯ä½•ã‹ã€ã©ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã®ã‹ã€ã¨ã„ã£ãŸã“ã¨ã‚‚ä½µã›ã¦ã¾ã¨ã‚ã¦ã‚ã‚Šã¾ã™ã®ã§è‰¯ã‘ã‚Œã°ã”å‚è€ƒã«ã©ã†ã)ã€‚




### ç”¨é€”åˆ¥polyfillã®å…¥ã‚Œæ–¹


polyfillã®å…¥ã‚Œæ–¹ã«ã¯å¤§ãã3ç¨®é¡ã‚ã‚Šã¾ã™ã€‚

| ç”¨é€”                                   | æ–¹æ³•                                                               |
|----------------------------------------|--------------------------------------------------------------------|
| å¿…è¦ãªpolyfillã ã‘å…¥ã‚Œã‚‹               | `useBuiltIns`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ **usage** ã‚’ä½¿ã†                           |
| å…¨ã¦ã®polyfillã‚’å…¥ã‚Œã‚‹                 | [@babel/polyfill](https://babeljs.io/docs/en/babel-polyfill){:target="_blank"}ã‚’import/requireã™ã‚‹                                            |
| ã‚°ãƒ­ãƒ¼ãƒãƒ«æ±šæŸ“ã›ãšã«polyfillã‚’é©ç”¨ã™ã‚‹ | [@babel/runtime](https://babeljs.io/docs/en/babel-runtime){:target="_blank"}ã¨<br>[@babel/plugin-transform-runtime](https://babeljs.io/docs/en/babel-plugin-transform-runtime){:target="_blank"}ã‚’ä½¿ã† |

<p></p>

å¤§å¹…ã«å¤‰æ›´ã•ã‚ŒãŸã®ãŒ`useBuiltIns`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ™å‹•ã§ã™ã€‚6.xã§ã¯ã¾ãšbabel-polyfillã‚’å…¥ã‚ŒãŸä¸Šã§ã€Œãã‚Œã‚’ã©ã®ã‚ˆã†ã«core-jsã«ç½®ãæ›ãˆã‚‹ã‹ã€ã‚’useBuiltInsã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã™ã‚‹å½¢ã§ã—ãŸã€‚
å¯¾ã—ã¦7.xã§ã¯`useBuiltIns`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦@babel/polyfillã‚’å…¥ã‚ŒãŸã‚Šå…¥ã‚Œãªã‹ã£ãŸã‚Šã—ã¾ã™ã€‚

ã§ã¯ãã‚Œãã‚Œã®æ–¹æ³•ã®è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚


#### 1. å¿…è¦ãªpolyfillã ã‘ã‚’å…¥ã‚Œã‚‹æ–¹æ³•

**[@babel/preset-env](https://babeljs.io/docs/en/babel-preset-env){:target="_blank"}ã®`useBuiltIns`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’`usage`ã¨ã™ã‚‹**ã¨ã€@babel/polyfillã‚’ã‚½ãƒ¼ã‚¹å†…ã§importã›ãšã¨ã‚‚å¿…è¦ãªpolyfillã ã‘ã‚’è‡ªå‹•ã§é¸åˆ¥ã—ã¦å…¥ã‚Œã¦ãã‚Œã¾ã™ã€‚ãŸã ã—ã€**@babel/polyfillã‚’npm installã—ã¦ãŠã**å¿…è¦ã¯ã‚ã‚Šã¾ã™ã€‚


**@babel/polyfill, @babel/preset-envã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹**
```shell
$ npm install -D @babel/preset-env
$ npm install -S @babel/polyfill
```

<p></p>

**.babelrcã‚’è¨˜è¿°ã™ã‚‹**
```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage"
      }
    ]
  ]
}
```

<p></p>

ã“ã®æ–¹æ³•ã¯ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãã„ã§ã™ãŒã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«**experimental**ã¨è¨˜ã•ã‚Œã¦ã„ã‚‹ç‚¹ãŒè¦æ³¨æ„ã§ã™ã€‚  
polyfillãŒå¿…è¦ãªå®Ÿè£…ä¾‹ã‚’[ã„ãã¤ã‹è©¦ã—ã¦ã¿ãŸ](https://github.com/aloerina01/til/tree/master/daily/20181128){:target="_blank"}ã¨ã“ã‚ã€é™çš„è§£æã—ã¦importã™ã‚‹polyfillã‚’ç‰¹å®šã—ã¦ã„ã‚‹é›°å›²æ°—ã§ã—ãŸã€‚åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸä¾‹ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã¿ã¾ã™ã€‚

```js
obj = {};
let letObj = {};
const constObj = {};

obj['includes'];      // array.includes ã¨ string.includes ã®polyfillãŒå…¥ã‚‹
letObj['includes'];   // polyfillãŒå…¥ã‚‰ãªã„
constObj['includes']; // polyfillãŒå…¥ã‚‰ãªã„
```
ã“ã®ä¾‹ã§ã¯ã€`let`ã‚‚`const`ã‚‚ä½¿ã‚ãšã«å®šç¾©ã•ã‚ŒãŸ`obj`ã«å¯¾ã—ã¦`includes`ã‚’å‘¼ã³å‡ºã™ã¨ã€Stringã®`includes`ã¨Arrayã®`includes`ã®polyfillãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚è¨€ã„æ›ãˆã‚Œã°ã€ã‚¹ã‚³ãƒ¼ãƒ—ãŒæ˜ç¢ºãª`letObj`ã¨`constObj`ã«å¯¾ã—ã¦ã¯ã€ãã®å‹ãŒArrayã§ã‚‚Stringã§ã‚‚ãªã„ã¨åˆ¤å®šã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚

è³¢ã„ãªã‚ã¨é–¢å¿ƒã—ãŸã‚‚ã®ã®ã€productionåˆ©ç”¨ã¯ã¡ã‚‡ã£ã¨æ€–ã„â€¦ã¨ã„ã†ã®ãŒä»Šã®æ°—æŒã¡ã§ã™ã€‚

ã¡ãªã¿ã«ã€Œimportã•ã‚Œã¦ã„ã‚‹ã‹æ€ªã—ã„polyfillã‚’å€‹åˆ¥ã«æ‰‹å‹•ã§importã™ã‚‹ã€æ¡ˆã‚‚è€ƒãˆãŸã®ã§ã™ãŒã€æ‰‹å‹•ã§å…¥ã‚ŒãŸã‚‚ã®ã¨ã®é‡è¤‡åˆ¤å®šã¯ã—ã¦ãã‚Œãªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ã“ã®æ¡ˆã‚‚ãƒ€ãƒ¡ãã†ã§ã™ã­ğŸ˜³


#### 2. å…¨ã¦ã®polyfillã‚’å…¥ã‚Œã‚‹æ–¹æ³•

Babel6.xã¾ã§ã¨åŒã˜ã‚ˆã†ã«**[@babel/polyfill](https://babeljs.io/docs/en/babel-polyfill){:target="_blank"}ã‚’import/requireã™ã‚‹**æ–¹æ³•ã§ã™ã€‚åˆã‚ã›ã¦`useBuiltIns`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«`entry`ã‹`false(default)`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**@babel/polyfill, @babel/preset-envã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹**

```shell
$ npm install -D @babel/preset-env
$ npm install -S @babel/polyfill
```

<p></p>

**ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§polyfillã‚’èª­ã¿è¾¼ã‚€**

```js
// index.js

import '@babel/polyfill';

Promise.resolve();  // polyfillãŒå¿…è¦ãªå®Ÿè£…
```

<p></p>

**.babelrcã‚’è¨˜è¿°ã™ã‚‹**
```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "entry"  // ä»»æ„
      }
    ]
  ]
}
```

`useBuiltIns`ã«`entry`ã‚’æŒ‡å®šã™ã‚‹ã¨ã€@babel/polyfillã®importã‚’**ç”Ÿã®core-jsã®importã«ç½®æ›ã—ã¦ãã‚Œã¾ã™**ã€‚ã¾ãŸã€ä»Šã¾ã§é€šã‚ŠåŒã˜polyfillã‚’è¤‡æ•°å›importã™ã‚‹ã®ã¯NGãªã®ã§ãã®ç‚¹ã‚‚ãŠå¿˜ã‚Œãªãã€‚


#### 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«æ±šæŸ“ã›ãšã«polyfillã‚’é©ç”¨ã™ã‚‹æ–¹æ³•

Babel6.xã¾ã§ã§ã¯`babel-plugin-transform-runtime`ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸãŒã€7.xã‹ã‚‰ã¯2ã¤ã®moduleã‚’ä½¿ã„ã¾ã™ã€‚

* [@babel/runtime](https://babeljs.io/docs/en/babel-runtime){:target="_blank"} ... ã‚½ãƒ¼ã‚¹ã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã‚‹polyfillæœ¬ä½“
* [@babel/plugin-transform-runtime](https://babeljs.io/docs/en/babel-plugin-transform-runtime){:target="_blank"} ... polyfillãŒå¿…è¦ãªç®‡æ‰€ã‚’@babel/runtimeã«ç½®ãæ›ãˆã¦ãã‚Œã‚‹ã‚‚ã®

**@babel/runtime, @babel/plugin-transform-runtimeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹**

```shell
$ npm install -S @babel/runtime
$ npm install -D @babel/plugin-transform-runtime
```

<p></p>

**.babelrcã‚’è¨˜è¿°ã™ã‚‹**

```js
{
  "plugins": ["@babel/plugin-transform-runtime"]
}
```

<p></p>

åˆ©ç”¨ã®éš›ã¯ã€Babel6.xã¾ã§ã¨åŒæ§˜ã«**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä½¿ãˆãªã„**ã¨ã„ã†ã“ã¨ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### useBuiltInsã®ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

ã“ã“ã‹ã‚‰ã¯ä½™è«‡ã§ã™ã€‚  
useBuiltInsã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹æ°—ã«ãªã£ãŸã®ã§ã€è»½ãã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã¿ã¾ã—ãŸã€‚ãã®ã¨ãã®ãƒ¡ãƒ¢ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

##### [<i class="fas fa-check"></i> babel-preset-env/src/index.js#L285](https://github.com/babel/babel/blob/59e9c6322baf6cbd1952c40ce5dd0b2ea7802712/packages/babel-preset-env/src/index.js#L285){:target="_blank"}

`useBuiltIns`ã®å€¤ã«å¿œã˜ã¦åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’åˆ†å²ã—ã¦ã„ã¾ã™ã€‚

* entryè¨­å®šæ™‚ [babel/use-built-ins-entry-plugin.js](https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-entry-plugin.js){:target="_blank"}
* usageè¨­å®šæ™‚ [babel/use-built-ins-plugin.js](https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-plugin.js){:target="_blank"}

ã“ã‚Œã‚‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€ã©ã¡ã‚‰ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ãªPluginã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```js
export default function({ types: t }: { types: Object }): Plugin;

type Plugin = {
  visitor: Object,  // polyfill ã® import ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®å‡¦ç†ç¾¤
  pre: Function,   // ãƒ¡ã‚¤ãƒ³å‡¦ç†å‰ã«å®Ÿè¡Œã™ã‚‹ã“ã¨
  name: string     // pluginã®è­˜åˆ¥å­ã®ã‚ˆã†ãªã‚‚ã®
}
```
Plugin.visitorãŒå¤§ããå·®ãŒå‡ºã‚‹éƒ¨åˆ†ã§ã™ã­ã€‚


##### [<i class="fas fa-check"></i> babel-preset-env/src/use-built-ins-entry-plugin.js#L31](https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-entry-plugin.js#L31){:target="_blank"}

Plugin.visitorã«æ¸¡ã•ã‚Œã‚‹`isPolyfillImport`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¦‹ã‚‹ã¨ã€`ImportDeclaration`é–¢æ•°ã«ã€Œ@babel/polyfillãŒimportã•ã‚Œã¦ã‚‹ãªã‚‰ãƒ•ãƒ©ã‚°ã‚’ãŸã¦ã¦ã€ãã‚Œã‚’å¿…è¦ãªmoduleã®importã«replaceã—ã¦ã„ãã€ã¨ã„ã£ãŸå®Ÿè£…ãŒã‚ã‚Šã¾ã™ã€‚

##### [<i class="fas fa-check"></i> babel-preset-env/src/use-built-ins-plugin.js#L68](https://github.com/babel/babel/blob/master/packages/babel-preset-env/src/use-built-ins-plugin.js#L68){:target="_blank"}





