---
title: Babel7.x時代のpolyfillの入れ方とuseBuiltInsの仕組み
outline: 
categories: ['JavaScript', 'Babel', 'Environment']
---


ES2015+で実装するためにBabelのpolyfillを利用する場面は多いと思いますが、Babel6.xまでと7.xではその入れ方が変わっているので注意が必要です(執筆時点でのBabelのバージョンは7.1.0です)。今回はBabel7.xでの用途別polyfillの入れ方と、キモとなる`useBuiltIns`オプションの挙動についてまとめてみます。

その前に6.xまでの入れ方をおさらいしておきます。

1. ソース内で[babel-polyfill](https://babeljs.io/docs/en/6.26.3/babel-polyfill){:target="_blank"}をimport/requireする(同時に`useBuiltIns:true`オプションを利用可)
2. webpackなどで[babel-polyfill](https://babeljs.io/docs/en/6.26.3/babel-polyfill){:target="_blank"}と結合してbundleする
3. [babel-plugin-transform-runtime](https://babeljs.io/docs/en/6.26.3/babel-plugin-transform-runtime){:target="_blank"}を使う

これらの手法にはメリット・デメリットがあり、場面に応じて使い分けが必要でした。詳細は[Babelの設定を見直すための逆引きガイド]({% post_url /blog/2018-03-19-1 %}){:target="_blank"}にまとめてあります(polyfillのことだけでなく、Babelとは何か、どのように利用するのか、といったことも併せてまとめてありますので良ければご参考にどうぞ)。

以下、本編です。

* TOC
{:toc}

### 用途別polyfillの入れ方


polyfillの入れ方には大きく3種類あります。

| 用途                                   | 方法                                                               |
|----------------------------------------|--------------------------------------------------------------------|
| 必要なpolyfillだけ入れる               | `useBuiltIns`オプション **usage** を使う                           |
| 全てのpolyfillを入れる                 | [@babel/polyfill](https://babeljs.io/docs/en/babel-polyfill){:target="_blank"}を使う                                            |
| グローバル汚染せずにpolyfillを適用する | [@babel/runtime](https://babeljs.io/docs/en/babel-runtime){:target="_blank"}または<br>[@babel/plugin-transform-runtime](https://babeljs.io/docs/en/babel-plugin-transform-runtime){:target="_blank"}を使う |

<p></p>

大幅に変更されたのが`useBuiltIns`オプションの挙動です。6.xではまずbabel-polyfillを入れた上で「それをどのようにcore-jsに置き換えるか」をuseBuiltInsオプションで指定する形でした。
対して7.xでは`useBuiltIns`オプションに応じて@babel/polyfillを入れたり入れなかったりします。

ではそれぞれの方法の詳細を見ていきます。


#### 1. 必要なpolyfillだけを入れる方法

@babel/preset-envのオプションである`useBuiltIns`を`usage`とすると、@babel/polyfillをimportせずとも必要なpolyfillだけを自動で選別して入れてくれます。


#### 2. 全てのpolyfillを入れる方法



#### 3. グローバル汚染せずにpolyfillを適用する方法



### useBuiltInsの仕組み





