---
title: algoliaを使ってJekyll製ブログに全文検索をつけた話
outline:
categories: ['Jekyll', 'algolia']
---

### [algolia](https://www.algolia.com/){:target="_blank"}とは

> Products to accelerate search and discovery experiences across any device and platform.

algoliaとは**全文検索エンジンサービス**です。「algoliaサーバにブログやドキュメントなどのコンテンツデータをアップすると、そのデータを全文検索するAPIを利用できる」といった感じです。

例を挙げると、Vue, React, Webpack, babel などのドキュメントにある検索機能がalgolia製です。あれはalgoliaの機能のひとつのDocSearchによって実現されています。

今回は、このalgoliaを使ってブログに全文検索を実装した方法をまとめてみます。


### 手順

1. **[algolia](https://www.algolia.com/){:target="_blank"}**のフリーアカウントを取得する
2. **[jekyll-algolia](https://community.algolia.com/jekyll-algolia/){:target="_blank"}**を使い、ブログコンテンツをalgoliaサーバにアップする
3. **[autocomplete.js](https://www.algolia.com/doc/tutorials/search-ui/autocomplete/auto-complete/){:target="_blank"}**を使い検索窓を実装する




### 1. algoliaのフリーアカウントを取得する

サービスを利用するために[アカウントを作成](https://www.algolia.com/users/sign_up){:target="_blank"}します。

![dashboard](/assets/2018-10-11-1-dashboard.png)
アカウントを作成するとこのようなダッシュボードへアクセスできます。

上述の通り、アカウントを作成するとコンテンツをアップロードすることができ、そのデータに対してAPI経由で全文検索をすることができるようになります。algoliaが提供している機能は基本的にここまでで、検索窓や検索結果の表示などのUIは別途用意する必要があります。

ただ「ドキュメント」に全文検索を導入する場合は、検索窓などのWidgetがセットになった[DocSearch](https://community.algolia.com/docsearch/){:target="_blank"}という機能を使うことができます。  
ちなみにこれを利用するには審査が必要です。私は当初「algolia = DocSearch」だと思い込んでいたのでDocSearchの登録申請を出しましたが、審査で「これはドキュメントっつーよりブログよね？」とツッコミいただきました。


### 2. **jekyll-algolia**を使い、ブログコンテンツをalgoliaにアップする

algoliaにコンテンツをアップする方法はいろいろあります。その中のひとつが[jekyll-algolia](https://community.algolia.com/jekyll-algolia/){:target="_blank"}です。

おさらいすると、Jekyllは「markdown等で書かれたコンテンツデータから静的サイトを生成する」ものです。  
jekyll-algoliaは「**markdown等で書かれたコンテンツデータから静的サイトを生成し、生成されたコンテンツをalgoliaにアップする**」ものです。実際に公開されているサイトを随時クロールしてデータを集める…といったようなことはしないわけですね。

このjekyll-algoliaを導入していきます。

#### Environment

* Jekyll >= 3.6.0
* Ruby >= 2.3.0

#### Installation

`Gemfile`にプラグインを追加し、インストールします。

```ruby
source 'https://rubygems.org'

gem 'jekyll', '~> 3.6'

group :jekyll_plugins do
  gem 'jekyll-algolia'
end
```

```shell
$ bundle install
```

#### Configuration

algoliaアカウントを作成後、ダッシュボードの「API Keys」にてApplication IDを確認し、`_config.yml`に設定を既述します。

```yaml

algolia:
  application_id: your_application_id
  index_name: mf_code # indexingする対象の名前をここで決めます。
```

私はブログを生成するための設定とAlgoliaにアップするための設定を一部変えたかったので、`_config.algolia.yml`と別ファイルにしました。

#### Usage

ダッシュボードの「API Keys」からAdmin API Keysを確認し、実行時に渡します。

```shell
$ ALGOLIA_API_KEY='your_admin_api_key' bundle exec jekyll algolia
```

<p></p>

私は実行時に読み込む設定ファイルを変更しています。

```shell
$ ALGOLIA_API_KEY='your_admin_api_key' bundle exec jekyll algolia --config ./_config.algolia.yml
```

![execute demo](/assets/2018-10-11-1-usage.gif)
<small>[Getting started](https://community.algolia.com/jekyll-algolia/getting-started.html){:target="_blank"}より</small>


#### Advanced

毎回手動で実行するのは面倒なので、CIでビルドする際に一緒に実行するようにします。  
ただ、algoliaのフリーアカウントでは1ヶ月のアップロード回数に限度があるので、記事コンテンツに修正があったときだけアップロードしたいところです。具体的には「**前回のCI実行時と比較し`_posts`以下に差分がある場合**」にアップロードします。

そのために必要なことは以下のとおりです。

* CIの環境変数にAdmin API Keyを登録する
* jekyll-algoliaを実行するスクリプトを実装する
  * CIの過去の実行結果を取得し、そのトリガーとなったCommit Idを取得する
  * 現在のCI実行のトリガーとなったCommit Idを取得する
  * それらのCommit Idのdiffを取得し、`_posts`以下の差分の有無を確認する
  * `_posts`以下に差分がある場合はjekyll-algoliaを実行する

スクリプトは[indexing.sh - aloerina01.github.io](https://github.com/aloerina01/aloerina01.github.io/blob/development/scripts/indexing.sh){:target="_blank"}に実装していますので、よければ参考にどうぞ(shell力の低い実装ですが…)。


### 3. **autocomplete.js**を使い検索窓を実装する

algoliaを使ってインクリメンタルサーチを実現できるライブラリが[autocomplete.js](https://www.algolia.com/doc/tutorials/search-ui/autocomplete/auto-complete/){:target="_blank"}です。

使い方は公式に則ってJSとCSSを読み込みDOMを任意の場所に配置するだけなので割愛します。