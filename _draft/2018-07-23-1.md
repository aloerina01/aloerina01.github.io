---
title: DartでWebフロントの開発はできる？ エコシステムから見るDartの現状
categories: [Dart, Environment]
outline: 
---

JSに似て読み書きしやすいシンタックスに加え、型推論やジェネリクスなど魅力的な機能を備えたDart。JavaScriptに変換する仕組みがある点や、**iOS、Android、Webの3大Clientで使える言語**を目指して設計されている点を踏まえると、DartでのWebフロントエンド開発も夢ではないように感じます(Dartの詳細については[WebフロントエンジニアがDart × Flutterに入門した話]({% post_url /blog/2018-07-01-1 %}){:target="_blank"}も併せてどうぞ)。

ただ、言語がよければすぐに使えるというわけではなく、使いやすさや開発環境も大切な要素の1つです。  
昨今のWebフロントエンドはできることが増え、それに伴いエコシステムもとても進歩していて、複雑で大規模な開発でもスムーズに行えるようになってきている印象です(1番最初の環境構築が大変とよく言われますが、その大変さも徐々に緩和されてきていると思います)。

そこで、**DartでのWebフロントエンド開発がどの程度現実的なのか**を「エコシステム」という観点でまとめてみました。備忘を兼ねて、各々のツールの簡単な使い方も併記しています。



* コンパイラとBuild周り → **build.yaml**
	* dartをjsにする → **DDC, dart2js**
	* sassをcssにする → **sass_builder**
* ローカルサーバとデバッグ環境 → **webdev**
	* 差分のwatch
	* ホットリロード


* TOC
{:toc}


### Dart SDK

Dart SDK はDartの開発に必要なライブラリ群とコマンドラインツールです。執筆時点では安定版の`1.24.3`と、プレリリース版の`2.0.0-dev.69.2`が存在します。


```shell
$ brew tap dart-lang/dart
$ brew install dart         # 安定版をインストールする場合
$ brew sintall dart --devel # プレリリース版をインストールする場合
```

なお、Web開発のためにDartをインストールする場合は、インストール時に`--with-dartium --with-content-shell`オプションをつけることが推奨されていますが、これらはDart1.xでのみ利用するものです。**Dartium**はDartVMを内蔵するブラウザで、**content shell**は同じくDartVMを内蔵するテスト用のヘッドレスブラウザですが、Dart2.xではDartからJavaScriptへ変換するコンパイラが大幅に変わりこれらが不要となったためです(コンパイラの詳細は後述します)。  
以降はプレスリリース版のDart2.xで検証や実装を進めます。

### パッケージ管理ツール pub

DartSDKをインストールすると併せて**[pub](https://www.dartlang.org/tools/pub){:target="_blank"}というパッケージ管理ツール**がインストールされます。パッケージの依存関係とバージョン情報を載せたファイルを用意してコマンドラインで一発インストール、というnpmでもお馴染みのものです。

#### pubspec.yaml

**依存するパッケージ**と**そのバージョン情報**などを記しておくファイルです。`package.json`のような役割をします。npmのような感覚で利用できるのでWebフロントエンド開発に携わる人ならスムーズに利用できると思います。

~~~yml
name: Sample
version: 1.0.0
description: Sample project
author: Aloerina
homepage: https://aloerina01.github.io
documentation: https://github.com/aloerina01/aloerina01.github.io/blob/development/README.md
environment:
  sdk: '>=2.0.0-dev.68.0 <3.0.0'
dependencies:
  bootstrap_sass: ^4.1.2
dev_dependencies:
  build_web_compilers: ^0.4.0
  test: '>=0.6.0 <0.12.0'
~~~

サンプルを見ると、やはりどことなく`package.json`に似ていますね。

強いて言うなら、依存パッケージを追加するときにエディタで直接修正する必要があるのはいかがなものかと思いました。[Dart Packages](https://pub.dartlang.org/){:target="_blank"}でインストールしたいパッケージを調べ`pubspec.yaml`への記述方法を確認しコピペする…というのはやはり手間です。

#### den
そこで助かるツールが**[den](https://github.com/seaneagan/den){:target="_blank"}**です。`npm init`や`npm install -S <package名>`のような、`pubspec.yaml`の初期化や依存関係の追記をしてくれるCLIツールです。

~~~shell
$ pub global activate den
$ den install <package名>
~~~


#### pubの基本コマンド


#####  pub get

`pubspec.yaml`に書かれている依存ライブラリを一括インストールしローカルにキャッシュします。同時に、初回であれば`pubspec.lock`と`.packages`が作成されます。前者は名前の通りバージョンのロックファイルで、後者はローカルのどのディレクトリにキャッシュしたかを記すファイルです。ローカルキャッシュから再インストールする場合は`--offline`オプションを使います。

#####  pub upgrade

依存パッケージのバージョンを最新にあげ、`pubspec.lock`の内容を更新します。


##### pub global activate <package>

`npm install -g`と同じです。パッケージをグローバルにインストールします。

#### pub用語

npmと同じ感覚でドキュメントを読み進めていくと齟齬が出る(出た)用語をピックアップしておきます。詳細は[公式の用語集](https://www.dartlang.org/tools/pub/glossary){:target="_blank"}からどうぞ。

##### Application package / Library package

Application packageとLibrary packageは対義語です。Application packageとはコマンドラインやブラウザから直接呼び出させるpackageを指し、Library packageはApplication packageからライブラリとして利用されるpackageです。

##### Entrypoint

意味合い的にはJavaScriptを実装するときと同じなのですが、Dartのpackageにおいては一般的に`main()`が実装されている`.dart`ファイルがエントリーポイントとなります。



### projectの雛形の構築

**[stagehand](https://github.com/dart-lang/stagehand){:target="_blank"}**というツールを利用してDartのプロジェクトの雛形を作ることができます。Reactでいうcreate-react-appやVueでいうvue-cliのようなものです。グローバルにインストールして雛形を作りたいディレクトリで実行します。

~~~shell
$ pub global activate stagehand
$ mkdir first_project
$ cd first_project
$ stagehand <template名>
~~~

Templateは現時点で6種類ありますが、Webアプリ開発用は

* 必要最低限のみ用意された**web-simple**
* AndularDartを組み込むための**web-angular**

の2つです。web-simpleでプロジェクトを作ってみたところ、HelloWorld的なHTML/CSS/Dartファイルとpubspec.yamlなどが用意されました。雛形が用意されたあとは依存するpackageをインストールしてローカルサーバを立ち上げればブラウザで確認できます。このあたりも`npm install`からの`npm start`と同じ流れなので理解しやすいしお手軽でした。

~~~shell
$ pub get       # 依存packageのインストール
$ webdev serve  # ローカルサーバの起動
~~~

サーバの起動に使っているwebdevについては後述します。


### コンパイラとビルド環境

Dartで作られたWebアプリを実行するには、**DartVMが搭載されたブラウザで直接実行する**か、**JavaScriptにコンパイルしてから標準ブラウザで実行する**か、の2つの方法があります。開発やテストといった過程では前者でも十分ですが、リリースするには後者の方法をとる必要があるため、用途に応じてコンパイラや実行環境を使い分ける必要があります。

Dartのコンパイラにはどんなものがあるのかと、それぞれのDartバージョンでどのようにそれらを使えばよいかをまとめておきます。

#### 2つのコンパイラ dart2js と DDC

**[Dart-to-JavaScript Compiler(dart2js)](https://webdev.dartlang.org/tools/dart2js){:target="_blank"}**はDart1.xから存在するコンパイラです。コードの最適化をしたりminifyなどのオプションがあったりと本番用のコンパイルができるだけでなく、問題のある箇所をワーニング表示したりと開発用に利用することもできます。

**[Dart Development Compiler(DDC)](https://webdev.dartlang.org/tools/dartdevc){:target="_blank"}**はDart2.xで登場したコンパイラです。その名の通り開発用に特化しており、差分ビルドやホットリロードに対応しています。

#### Dart1.xでのビルド環境

dart1.xでは、開発時はDartVMを搭載した**Dartium**や**content shell**を利用し、リリース時にはdart2jsでコンパイルしてjsを生成します。それぞれpubコマンドを利用して行えます。

* `pub serve` ... ローカルサーバを起動します。Dariumで確認することができます。
* `pub build` ... dart2jsを実行します。


#### Dart2.xでのビルド環境

Dart2.xではDartVMを一切使わずに開発できます。そのためDartiumもcontent shellも必要なくなります。  
またDart2.xではbuildやserveのコマンドを、pubの代わりに**[webdev](https://webdev.dartlang.org/tools/webdev){:target="_blank"}**というCLIツールを使って行います。


#### まとめ

|                 | Dart1.x                                               | Dart2.x                                                      |
|-----------------|-------------------------------------------------------|--------------------------------------------------------------|
| for release     | `pub build`<br> dart2jsでjsを生成                     | `webdev build`<br> dart2jsでjsを生成                         |
| for development | `pub serve`<br> Dartium, content shell などのDartVM上で直接実行 | `webdev serve`<br> DDCでコンパイルしたものを標準ブラウザで実行 |






### 参考資料の読み方
webAPPの開発に関する資料は、GetStartedが少々、AndularDart用の資料がそこそこ、あとはトピック毎の資料がたくさん、という感じだったので、体系的に離開していくのが大変でした。
なのでこの記事で体系立てて(既存のWeb開発の要件と対比させながら)整理することにしました。

最後の関連資料の相関図をまとめておきます。

[Tools | Dart](https://www.dartlang.org/tools)
	├ [Dart Tools for the Web | webdev.dartlang.org](https://webdev.dartlang.org/tools)
		├ webdev
		├ dart2js
		├ DDC
		└ build_runner
	├ [Dart VM Tools | Dart](https://www.dartlang.org/dart-vm/tools)
	└ [DartPad | Dart](https://www.dartlang.org/tools/dartpad)
記事のベースとなる情報はここ。DartってDocumentがめちゃ充実しててありがたいのだけど、情報量が多くてどこから読めばスムーズかつ体系的に理解できるのかがわかりにくかったので(そして全部英語だったので)、ここにそのあらましをまとめておきます。

### PolymerDart
PolymerDartはDartのエコシステムにWeb標準機能とPolymerを対応させるためのプロジェクト。このプロジェクトはPolymer1.x(クラシックなdart2js)と、WebComponents1.xと、DDCと[Bazel](https://github.com/dart-lang/bazel)ビルドシステムを活用したPolymer2.xをサポートする。

ちなみにBazelはMavenやGradleやMakeのようなビルドツール。Javaとかネイティブアプリとかのビルドができるツールなんだけど、`dazel`と称してDartのビルドする機能もある(dart製のカスタマイズBazel？)。
`pub run`使ってるならすぐ使えるようになると思うよ、[とのこと](https://github.com/dart-lang/bazel/tree/master/dazel)。








### dart2js
webdevのserveコマンド(ローカルサーバ立ち上げるコマンド)はデフォルトでDDCを使うようになっているが、`--release`オプションをつけることでdart2jsを使うようになっている。
逆にwebdevのbuildコマンドで`--no-release`をつけるとDDCを使う。

また、`--output`オプションを使うと、どのディレクトリをトップディレクトリとするかとどのディレクトリに排出するかを指定できる

```shell
webdev build --no-release --output web:build
```
たとえばこれは、DDCをつかって、webディレクトリをトップディレクリとしてビルドして、結果をbuildディレクトリに打ち込む。

基本的な使い方は
```shell
dart2js input.dart --out output.js
```

本番用には圧縮したいので
```shell
dart2js input.dart --out output.js -m 
```


### pub_runner
ビルドスクリプトをカスタマイズするためのもの。CLIでコンポーネントテストをするわけじゃないならwebdevで十分だよと公式にて。
依存関係を`pubspec.yaml`に書く。
```yml
dev_dependencies:
	build_runner:^0.9.0
  build_web_compilers: ^0.4.0
  build_test:^0.10.2
```
package.jsonの依存関係のようなもの。npmと同じくこれを手動で書く必要はなく、一般的には`pub get`や`pub upgrade`をつかうことで依存関係が追記されていく。

実行する時はこんな感じ
```shell
pub run build_runner build
pub run build_runner serve
```

ビルド時に設定を適用したい場合は`build.yaml`に書く(このファイル名がデフォルト)。すると勝手に適用される。名前を変えたい場合は`build.hoge.hyml`と命名して
```shell
pub run build_runner build --config hoge
```
とする。
設定ファイルに関するREADME：[build/README.md at master · dart-lang/build · GitHub](https://github.com/dart-lang/build/blob/master/build_config/README.md)

実用的な利用場面は`build.dev.yaml`と`build.prod.yaml`で設定を切り換えるとかかな。

ちなみに`webdev build`はデフォルトで`dart2js`が走って、`webdev serve`はデフォルトで`DDC`が走る。


### Webdev
またDart2.x用のビルドツールは`pub`ではなく`webdev`。

> The webdev package provides a command line interface (CLI) for users and tools to build and serve web apps. 

`pub build` → `webdev build`
`pub serve` → `webdev serve`

webdevのinstallはpubから
```shell
$ pub global activate webdev                 

Resolving dependencies... **(4.3s)**
+ **args** 1.4.4
+ **charcode** 1.1.2
+ **collection** 1.14.11
+ **io** 0.3.3
+ **meta** 1.1.6
+ **path** 1.6.2
+ **pub_semver** 1.4.2
+ **source_span** 1.4.1
+ **stack_trace** 1.9.3
+ **string_scanner** 1.0.3
+ **webdev** 0.2.3
+ **yaml** 2.1.15
Downloading **webdev** 0.2.3...
Downloading **stack_trace** 1.9.3...
Downloading **io** 0.3.3...
Downloading **yaml** 2.1.15...
Downloading **meta** 1.1.6...
Downloading **charcode** 1.1.2...
Downloading **path** 1.6.2...
Downloading **string_scanner** 1.0.3...
Downloading **source_span** 1.4.1...
Downloading **args** 1.4.4...
Downloading **pub_semver** 1.4.2...
Downloading **collection** 1.14.11...
Precompiling executables... **(1.4s)**
Precompiled **webdev:webdev**.
Installed executable **webdev**.
Warning: Pub installs executables into **$HOME/.pub-cache/bin**, which is not on your path.
You can fix that by adding this to your shell's config file (.bashrc, .bash_profile, etc.):

  **export PATH="$PATH":"$HOME/.pub-cache/bin"**

Activated **webdev** 0.2.3.
```


### DartのWebプロジェクトの初め方
[Get Started](https://webdev.dartlang.org/guides/get-started)の3章から。
`webdev`と`stagehand`をインストールせよ、とのこと。webdevは上記のもの。stagehandはプロジェクト構築CLI(Dart Project Generator)っぽい。

```shell
pub global activate webdev
pub global activate stagehand
```

packageの雛形はいくつかあって、Webアプリに関するものは
```
server-shelf ... web server用
web-angular ... angularDartを使ったWebフロント用
web-simple ... webフロント用の必要最低限(html, css, dart)
```

[stagehand/templates at master · dart-lang/stagehand · GitHub](https://github.com/dart-lang/stagehand/tree/master/templates)
ここを見れば実際に何がはいっているかわかる

とりあえず`web-simple`ではじめる
```shell
stagehand web-simple
```

vscodeでパッケージの雛形をつくったら「依存関係のあるライブラリがはいってないよ」とアラートが出て、勝手に`pub get`してくれた。イメージ的には「npm installしわすれてるからしてあげといたよ」って感じかな。
getして端末にインストールされたライブラリの情報は`.package`に、バージョン情報は`pubspec.lock`にかかれている感じかな？

一通り揃った感じがあるのでローカルサーバの立ち上げ
```shell
webdev serve
```
`localhost:8080`で確認できた。

`/web/main.dart`の一部を書き換えて保存したら自動で差分ビルドが走ってローカルサーバ上で更新。ブラウザでリロードしたら反映。このへんもWeb開発に近くて自然。

ここまでの所感。
npm install して npm start でローカルサーバ立ち上がって即開発開始！っていう感覚とほぼ同じなので違和感なく開発にとっかかれそう。


### pubspec.yml

```yml
dev_dependencies:
  build_runner: ^0.9.0
  build_web_compilers: ^0.4.0
```

`build_web_compiler`は「ブラウザでコードを実行したい人はつかう」Compiler。
([build_web_compilers | Dart Package](https://pub.dartlang.org/packages/build_web_compilers)参照)

これさえ書いてあれば、あとは自動生成されたビルドスクリプトがよしなにしてくれる。
(つまり何も書かなくてもビルドできる)

`webdev serve`はデフォルトでDDCを利用するので、dart2jsを使いたい場合は`build.yaml`を書く必要がある。

```yml
targets:
	$default:
		builders:
			build_web_compilers|entrypoint:
				generate_for:
				- test/**.browser_test.dart
				- web/**.dart
				options:
					compiler: dart2js
					dart2js_args:
						- --checked
```
[build/README.md at master · dart-lang/build · GitHub](https://github.com/dart-lang/build/blob/master/build_config/README.md)
[build/build_yaml_format.md at master · dart-lang/build · GitHub](https://github.com/dart-lang/build/blob/master/docs/build_yaml_format.md)




### 感想
仮想DOMを扱うVueやReactのWrapperがライブラリが出ればまじで来るんじゃないかな、Dart。