---
title: masterãƒãƒ¼ã‚¸ã®å‰ã«masterã®å±¥æ­´ãŒé€²ã‚“ã§ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ãŸ
outline:
categories: [shell, Environment]
---

git-flowã‚„github-flowã§é–‹ç™ºã‚’è¡Œã£ã¦ã„ã‚‹ã¨ã€releaseãƒ–ãƒ©ãƒ³ãƒã«hotfixãƒ–ãƒ©ãƒ³ãƒã§ç©ã¾ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆãŒåæ˜ ã•ã‚Œã¦ãŠã‚‰ãšã€ãƒªãƒªãƒ¼ã‚¹ãŒå·»ãæˆ»ã£ã¦ã—ã¾ã†äº‹æ•…ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã—ãŸã€‚

![flowå›³](/assets/2018-06-15-1-main.jpg)
(developãƒ–ãƒ©ãƒ³ãƒãªã©ã¯çœç•¥ã—ã¦ã„ã¾ã™)

ãã¡ã‚“ã¨æ‰‹å‹•ã§releaseãƒ–ãƒ©ãƒ³ãƒã«masterã‚„hotfixã‚’ãƒãƒ¼ã‚¸ã™ã‚Œã°èµ·ããªã„å•é¡Œã§ã™ãŒã€ã„ã‹ã‚“ã›ã‚“äººã¯**ã†ã£ã‹ã‚Šå¿˜ã‚Œã¦ã—ã¾ã†**ç”Ÿãç‰©ã§ã™ã€‚ãã“ã§ã€Œãƒãƒ¼ã‚¸ã—å¿˜ã‚Œã¦ã„ã‚‹ã‚ˆï¼ã€ã¨æ•™ãˆã¦ãã‚Œã‚‹shellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚


### å®Ÿéš›ã®ã‚½ãƒ¼ã‚¹

```shell
#!/bin/bash
set -e

text_color_red="\033[37;41;1m"
text_color_green="\033[37;42;1m"
text_color_reset="\033[0m"
target_branch=$1

git fetch

# masterã®æœ€æ–°ã®commitã‚’å–å¾—ã™ã‚‹
latest_commit=$(git log origin/master -n 1 | head -1 | sed -e "s/commit \(.*$\)/\1/")

# target_branchãŒmasterã®ã©ã®commitã‹ã‚‰æåˆ†ã‹ã‚Œã—ãŸã®ã‹ã‚’èª¿ã¹ã‚‹
base_commit=$(git show-branch --merge-base origin/$target_branch origin/master | head -1)

echo "latest commit: $(git log $latest_commit --oneline | head -1)"
echo "based  commit: $(git log $base_commit --oneline | head -1)"

# ã€Œmastarã®æœ€æ–°commitã€ã¨ã€Œæåˆ†ã‹ã‚Œã—ãŸcommitã€ã‚’æ¯”è¼ƒ
if [ "$latest_commit" = "$base_commit" ]; then
  comment="æœ€æ–°ã®masterãŒå–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã¾ã™"
  icon="âœ… "
  event="APPROVE"
  echo -e "${text_color_green}${comment}${text_color_reset}"
else
  comment="masterãŒé€²ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
  icon="ğŸš« "
  event="REQUEST_CHANGES"
  echo -e "${text_color_red}${comment}${text_color_reset}"
fi

# CIã«ã‚ˆã‚‹å®Ÿè¡Œã§ãªã‘ã‚Œã°ã“ã“ã§çµ‚äº†
if [ "$CI" == false ] || [ -z "$CI" ]; then
  exit 0
fi

# è©²å½“ã®Pull Requestã‚’å–å¾—ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
if [ "$CI_PULL_REQUEST" == false ] || [ -z "$CI_PULL_REQUEST" ]; then
  echo 'Fail to find a pull request.' && exit 0
fi
pr_number=$(echo ${CI_PULL_REQUEST} | sed -e "s/^.*pull\/\(.*$\)/\1/")

# çµæœã‚’Pull Requestã«Reviewã¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹
curl -XPOST \
  -H "Authorization: token $GITHUB_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"body\": \"$icon$comment\", \"event\": \"$event\"}" \
 https://github.com/api/v3/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls/$pr_number/reviews
```

ã‚½ãƒ¼ã‚¹ã¯[GitHub](https://github.com/aloerina01/check-master-history)ã§ã‚‚å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
