---
layout: post
title: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¡ãƒ¢ã‚’æ™’ã—ã¦ã¿ã‚‹  webpackå‹•çš„moduleç·¨
outline: é–‹ç™ºã‚’ã—ã¦ã„ã‚‹ã¨å£ã«ã¶ã¡å½“ãŸã‚‹ã¨ã“ãŒã‚ˆãã‚ã‚Šã¾ã™ãŒã€ãã‚“ãªã¨ãã«è‡ªåˆ†ãŒã©ã‚“ãªå¯¾å‡¦ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚’æ™’ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚ä½œæ¥­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¦‹ã›ã‚‹ãƒ»è¦‹ã¦ã‚‚ã‚‰ã†æ©Ÿä¼šã£ã¦ãªã‹ãªã‹ãªã„ã®ã§ã€ä½•ã‹ã®ãã£ã‹ã‘ã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ğŸ˜‰
categories: [JavaScript, Webpack]
---

### ã¾ãˆãŒã

PCã®ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã«ã¤ãã€æ—§PCã®ãƒ­ãƒ¼ã‚«ãƒ«ã«æ®‹ã£ã¦ãŸãƒ¡ãƒ¢ã‚„ã‚‰ãƒ–ãƒ­ã‚°ç”¨ä¸‹æ›¸ãã®æ•´ç†ã‚’ã—ã¦ã„ãŸã‚‰ã€ã‹ã¤ã¦è‡ªåˆ†ãŒãƒãƒã£ãŸãƒˆãƒ©ãƒ–ãƒ«ã®å¯¾å¿œæ™‚ã®ãƒ¡ãƒ¢ãŒç™ºæ˜ã•ã‚Œã¾ã—ãŸã€‚èª­ã¿è¿”ã—ã¦ã¿ãŸã‚‰æ‡ã‹ã—ã„æ°—æŒã¡ã«ãªã‚ŒãŸã‚Šã€å½“æ™‚è€ƒãˆã¦ã„ãŸã“ã¨ãŒæ€ã„å‡ºã›ãŸã‚Šã¨ã„ã„ã“ã¨ãŒå¤šã‹ã£ãŸã®ã§ã€æ™’ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ã¡ãªã¿ã«ãƒ¡ãƒ¢ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¯ã€**webpackã§å‹•çš„moduleè§£æ±ºã—ã‚ˆã†ã¨ã—ã¦æ­»ã«ã‹ã‘ãŸ**ã€ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚

â€» 2017å¹´ä¸Šæ—¬ã«æ®‹ã—ãŸãƒ¡ãƒ¢ãªã®ã§ã€å†…å®¹ã«å¤ã„ç®‡æ‰€ãŒã‚ã£ãŸã‚Šå¼•ç”¨æ–‡ã¨ãƒªãƒ³ã‚¯å…ˆã®æ–‡ç« ã«ã‚ºãƒ¬ãŒã‚ã£ãŸã‚Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒ¡ãƒ¢å†…å®¹

#### ã“ã¾ã£ãŸã“ã¨ã«ãªã£ãŸã

```js
let modulePath;
switch (flag) {
  // çœç•¥
  // modulePathã‚’å‹•çš„ã«æ±ºå®šã™ã‚‹
}
let Constructor = require(modulePath);
let instance = new Constructor();
```

ã¨ã„ã†ã“ã¨ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

```bash
Error: Cannot find module "."
```

`modulePath`ãŒæ–‡å­—åˆ—ã¨ã—ã¦ã¡ã‚ƒã‚“ã¨èªè­˜ã§ãã¦ã„ãªã„ã®ã‹ã¨æ€ã£ãŸã‘ã©ãã†ã§ã‚‚ãªã‹ã£ãŸã€‚

```js
// æ¤œè¨¼1
let Constructor = require(modulePath + '');  // åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼

// æ¤œè¨¼2
console.log(typeof modulePath);  // string
```

ã‚‚ã—ã‚„`modulePath`ã¯æ­£è¦è¡¨ç¾ã˜ã‚ƒãªã„ã¨ã ã‚ï¼Ÿã€€ã¨ã‹è¡€è¿·ã£ã¦ã¿ãŸã€‚

```js
let modulePath = /model\/userlist/;
let Constructor = require(modulePath);  // ã‚„ã¯ã‚Šã‚¨ãƒ©ãƒ¼
```

ã“ã“ã§ã‚ˆã†ã‚„ãwebpackã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è§£æ±ºã«èµ·å› ã™ã‚‹ã¨æ°—ã¥ãã€‚

>  Keep in mind that import() path cannot be fully dynamic (e.g., import(Math.random())). Rather either completely static (e.g., import('./locale/de.json')) or partially static (e.g., import('./locale/' + language + '.json')).
[Code Splitting - Using import()](https://webpack.js.org/guides/code-splitting-import/#dynamic-import)

> A context is created if your request contains expressions, so the exact module is not known on compile time.
[Dependency Management](https://webpack.js.org/guides/dependency-management/#require-with-expression)



#### require with expressionã€€è¨³ã—ã¦ã¿ã‚‹(Googleç¿»è¨³)

> A context is created if your request contains expressions, so the exact module is not known on compile time.

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ­£ç¢ºãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒèªè­˜ã•ã‚Œã¾ã›ã‚“ã€‚

Example:
```js
require("./template/" + name + ".ejs");
```

> webpack parses the require() call and extracts some information:

webpackã¯requireï¼ˆï¼‰å‘¼ã³å‡ºã—ã‚’è§£æã—ã€ã„ãã¤ã‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚

```plain
Directory: ./template
Regular expression: /^.*\.ejs$/
```

####  context module ã£ã¦ãªã‚“ã 

> A context module is generated. It contains references to all modules in that directory that can be required with a request matching the regular expression. The context module contains a map which translates requests to module ids.

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€æ­£è¦è¡¨ç¾ã«ä¸€è‡´ã™ã‚‹è¦æ±‚ãŒå¿…è¦ãªã€ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®å‚ç…§ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¯ã€è¦æ±‚ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«IDã«å¤‰æ›ã™ã‚‹ãƒãƒƒãƒ—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

Example:
```js
{
    "./table.ejs": 42,
    "./table-row.ejs": 43,
    "./directory/folder.ejs": 44
}
```

> The context module also contains some runtime logic to access the map.
> 
> This means dynamic requires are supported but will cause all possible modules to be included in the bundle.

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¯ã€ãƒãƒƒãƒ—ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ ã“ã‚Œã¯å‹•çš„è¦ä»¶ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãŒã€ã™ã¹ã¦ã®å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãƒãƒ³ãƒ‰ãƒ«ã«å«ã¾ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

#### context module API

> A context module exports a (require) function that takes one argument: the request.
> The exported function has 3 properties: resolve, keys, id.

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€1ã¤ã®å¼•æ•°ï¼ˆrequestï¼‰ã‚’å—ã‘å–ã‚‹ï¼ˆrequireï¼‰é–¢æ•°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸé–¢æ•°ã«ã¯ã€resolveã€keysã€idã¨ã„ã†3ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã¾ã™ã€‚


#### çªå¦‚è§£æ±ºã™ã‚‹

webpack1ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã“ã‚“ãªæ–‡ç« ã‚’è¦‹ã¤ã‘ã‚‹ã€‚

> If the module source contains a require that cannot be statically analyzed, the context is the current directory.
> In this case a Critical dependencies warning is emitted. You need to use the ContextReplacementPlugin in most cases.
> Examples: someFn(require) require.bind(null)

é™çš„è§£æ±ºã§ããªã„`require`ãŒã‚½ãƒ¼ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ã¨ãã®contextã¯ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãªã‚‹ã€‚

```js
let Constructor = require(modulePath);  // â† modulePathãŒã‚«ãƒ¬ãƒ³ãƒˆã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã§ãªã„ã¨ãƒ€ãƒ¡â€¦ï¼Ÿ
```

å®Ÿã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹è§£æ±ºã‚’ã—ãŸãã¦`webpack.config.js`ã«æ‰‹ã‚’å…¥ã‚Œã¦ã„ãŸã€‚

```js
module.exports = {
  // çœç•¥
  resolve: {
    extensions: ['.vue', '.js' ],
    // root: [ path.resolve('./js') ], // webpack 1
    modules: [
      path.resolve(__dirname + '/js'), // webpack 2
      path.resolve(__dirname + '/node_modules')
    ]
  }
```

`path.resolve`ã§æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ«ãƒ¼ãƒˆã¨ã—ãŸç›¸å¯¾ãƒ‘ã‚¹ã§æ›¸ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ã„ãŸ(ã¤ã‚‚ã‚Šã ã£ãŸ)ãŒã€å®Ÿéš›ã¯ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã®ãƒ‘ã‚¹ãŒå¿…è¦ã ã£ãŸã€‚

```js
let Constructor = require('../' + modulePath);  // å‹•ã„ãŸ
```



#### æ›´ã«ãªã‚“ã‹è¦‹ã¤ã‘ã‚‹

[Module](https://webpack.js.org/configuration/module/#module-contexts)

> These options describe the default settings for the context created when a dynamic dependency is encountered.

ã“ã‚Œã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€å‹•çš„ä¾å­˜é–¢ä¿‚ãŒç™ºç”Ÿã—ãŸã¨ãã«ä½œæˆã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¨˜è¿°ã—ã¾ã™ã€‚

ã©ã†ã‚„ã‚‰ä»Šå›ã®ã‚ˆã†ã«å‹•çš„ä¾å­˜è§£æ±ºãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã®ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ãŒå†…éƒ¨çš„ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹æ¨¡æ§˜ã€‚ãã—ã¦ãã‚Œã‚’æ›¸ãæ›ãˆã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ã‚ã‚‹æ¨¡æ§˜(ãŸã ã—Deprecated)ã€‚

```js
module: {
  exprContextCritical: true,
  exprContextRecursive: true,
  exprContextRegExp: false,
  exprContextRequest: ".",
  unknownContextCritical: true,
  unknownContextRecursive: true,
  unknownContextRegExp: false,
  unknownContextRequest: ".",          // â†ã‚¨ãƒ©ãƒ¼ã®æ–‡è¨€ã§è¦‹è¦šãˆã‚ã‚‹ãï¼ï¼ï¼
  wrappedContextCritical: false
  wrappedContextRecursive: true,
  wrappedContextRegExp: /.*/,
}
```

> Note: You can use the ContextReplacementPlugin to modify these values for individual dependencies. This also removes the warning.

ContextReplacementPluginã‚’ä½¿ç”¨ã—ã¦ã€å€‹ã€…ã®ä¾å­˜é–¢ä¿‚ã®ã“ã‚Œã‚‰ã®å€¤ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è­¦å‘Šã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

ãµã‚€ãµã‚€ğŸ¤”  
ã¨ã‚Šã‚ãˆãšå‹•ã„ã¦ã‚ˆã‹ã£ãŸã€‚
